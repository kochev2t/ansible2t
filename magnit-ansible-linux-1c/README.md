# Ansible

## Подготовка к работе

1. **Проверка установки Ansible:**
   - Убедитесь, что Ansible установлен на компьютере, с которого он будет запускаться. Для проверки используйте команду:
     ```bash
     sudo ansible --version
     ```
   - Если Ansible не установлен, [установите его](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html).

2. **Копирование каталога Ansible:**
   - Скопируйте каталог `ansible` в требуемое место, например, в корень.
   - При необходимости измените значение ключа `inventory` в конфигурационном файле `ansible.cfg` на путь к каталогу, куда скопирован `ansible`.

3. **Подготовка файла `hosts`:**
   - Создайте файл `hosts`, содержащий список хостов-клиентов и их групп.
   - Разбейте хосты на группы в зависимости от выполняемых на них ролей.

4. **Настройка файла `side.yml`:**
   - По умолчанию в файле `side.yml` заданы роли для установки сервера 1С "с нуля". При необходимости отредактируйте файл.
   - Пример использования всех ролей находится в файле `side_ALL.yml`.
   - Установите требуемую версию 1С в переменной `onec_version_name`. При необходимости отредактируйте другие переменные.
   - Скопируйте инсталляционный файл 1С в каталог, определенный в переменной `ins_dir_src`.

5. **Настройка пользователя Ansible:**
   - Пропишите пользователя, под которым будет запускаться Ansible, в групповых переменных в папке `.../group_vars`.
   - Обязательно заполните переменную `ansible_user`. В противном случае его придется указывать в строке запуска.
   - Пользователь текущего компьютера должен совпадать с пользователями на хостах.

6. **Запуск основного плейбука:**
   - Запуск основного плейбука выполняется из каталога `Ansible` командой:
     ```bash
     ansible-playbook -i hosts side.yml -K
     ```

7. **Отключение проверки ключа хоста:**
   - Если возникает ошибка:
     ```
     Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this. Please add this host's fingerprint to your known_hosts file to manage this host.
     ```
   - Выполните команду без `sudo`:
     ```bash
     export ANSIBLE_HOST_KEY_CHECKING=False
     ```

## `side.yml`

Основной плейбук `side_ALL.yml` запускается первым, а затем из него запускаются другие плейбуки ролей. В нем можно переопределить, какие роли должны выполняться на каких группах хостов или отдельных хостах.

Здесь заданы общие переменные, например, `onec_version_name` для установки версии 1С. Также можно переопределить переменные, если требуются их значения, отличные от значений по умолчанию (в соответствующих файлах ролей по пути `.../Имя роли/defaults/main.yml`).

Настроено два сценария, которые предполагается выполнять на разных группах серверов:
- Установка сервера приложения.
- Установка веб-сервера и публикация баз.

Кроме этого, сценарии разделены для возможности установки дополнительного сервера приложения 1С на другом порту (например, с отладкой и без отладки) и публикации на одном сервере нескольких баз. Решение таких задач реализовано с помощью создания различных групп хостов, в которые входят одни и те же хосты.

В сценариях установки сервера приложения 1С можно переопределить следующие переменные (которые по умолчанию заданы в папках `defaults` соответствующих ролей):
- `SRV1CV8_DEBUG`: Признак необходимости запуска сервера отладки. По умолчанию отладка отключена.
- `SRV1CV8_PORT`: Порт запуска `ragent`. По умолчанию 1540.
- `SRV1CV8_REGPORT`: Порт запуска `rmngr`. По умолчанию 1541.
- `SRV1CV8_RANGE`: Диапазон портов рабочих процессов. По умолчанию 1560:1591.
- `RAS_PORT`: Порт сервера администрирования. Если не задан, то ставится не будет. По умолчанию 1539.

Эти переменные будут действовать на все хосты соответствующей группы сценария.

## `siderev2.yml`

Плейбук `siderev2.yml` предназначен для запуска функции реструктуризации v2. Запускается после отработки основного плейбука, если требуется включить данную функцию. При необходимости файл можно отредактировать, как и другие переменные в нем.

Перед запуском скопируйте инсталляционный deb-пакет JRE в каталог, определенный в переменной `install_JRE` файла `siderev2.yml`.

Запуск плейбука выполняется из каталога `ansible` командой:
```bash
ansible-playbook -i hosts siderev2.yml -K
```

## Инвентори файл `hosts`

Позволяет распределять хосты по группам хостов и переопределять переменные для отдельных хостов. Здесь определены настройки публикаций баз 1С на веб-серверах. При необходимости можно переопределить переменные для установки сервера 1С предприятия, например, `SRV1CV8_DEBUG` — признак отладки на сервере.

Часть переменных можно определить в целом для группы хостов. Это можно сделать в файле с именем группы, расположенном в папке `.../group_vars`.

## Роли

В данной сборке используется ряд ролей:

1. **`install_deb_packages`**: Установка скачанных ранее deb-пакетов. Используется для установки Apache или дополнительных пакетов шрифтов для 1С (`fontconfig`).
   - Копируются файлы из папки `.../inst_deb_dir/deb_dir` во временную папку на хосте. Переменные `inst_deb_dir` и `deb_dir` определены.
   - Устанавливаются скопированные пакеты.
   - Удаляются скопированные файлы.

2. **`first_setup`**: Первоначальная настройка перед установкой платформы сервера 1С предприятия.
   - Копирование шрифтов из папки `./fonts` в `/usr/share/fonts`.
   - Создание группы пользователей `grp1cv8` и пользователя `usr1cv8`.
   - Создание различных каталогов: расположения программных файлов, специальных каталогов 1С, временных каталогов для инсталляционных файлов.
   - Копирование требуемых шрифтов.

3. **`install_1C`**: Установка платформы требуемой версии сервера 1С предприятия.
   - Остановка и удаление служб старых версий 1С. Это действие по умолчанию выполняется, но может быть не выполнено, если переменная `flag_Remove_old_1C_service` не равна `true`.
   - Копирование файла единого дистрибутива вида `setup-full-8.3.21.1393-x86_64.run` из папки `ins_dir_src/inst_file_name` в папку хоста `ins_dir_dest`. Переменные `ins_dir_src`, `inst_file_name` и `ins_dir_dest` определены.
   - Установка серверных компонентов платформы. Требуемые компоненты для установки определяются переменной `enable_components`. По умолчанию это серверные компоненты. В сценарии установки веб-сервера эта переменная переопределяется для установки только компонента `ws`.

4. **`install_ragent`**: Установка службы сервера 1С.
   - Подготовка файла настройки служб по требуемым параметрам (порты, пути к служебным директориям, необходимость и вид отладки и т.д.), определенным переменными `SRV1CV8_PORT`, `SRV1CV8_REGPORT`, `SRV1CV8_RANGE`, `SRV1CV8_DEBUG`.
   - Создание символьной ссылки на файл.
   - Создание и запуск служб `ragent`, `rmngr`, `rphost`, `dbgs`.

5. **`install_ras`**: Установка службы RAS.
   - Подготовка файла настройки службы сервера удаленного администрирования по требуемым параметрам (порты `ras`, `ragent`), определенным переменными `RAS_PORT`, `SRV1CV8_PORT`.
   - Создание символьной ссылки на файл.
   - Создание и запуск службы `ras`.

6. **`setup_apache`**: Настройка Apache после ее установки.
   - Копирование конфигурационных файлов.
   - Копирование файлов сертификатов. Сертификаты (`cert.key` и `cert.cer`) должны быть заранее получены и помещены в каталог `.../setup_apache/files/`.
   - Включение модулей для работы с SSL.

7. **`restart_apache`**: Перезапуск службы Apache.

8. **`publishing`**: Публикация базы 1С, ее веб-сервисов и HTTP-сервисов. Так как эти данные уникальны для хостов и не могут быть определены для группы, переменные прописаны в инвентори файле `hosts`.

9. **`monitoring_1C`**: Установка необходимых пакетов и добавление в CRON заданий для выполнения скрипта `zabbix_exporter.py` каждые 30 секунд.

10. **`install_JRE`**: Установка пакета JRE перед включением функции реструктуризации v2. Необходимо создать директорию по пути, указанному в переменной `install_JRE` файла `siderev2.yml`, и скопировать туда сам deb-пакет перед запуском роли.

11. **`enable_rv2`**: Роль для включения функции реструктуризации v2.
    **ВНИМАНИЕ!** Если после запуска и успешной отработки данной роли необходимо запускать другие плейбуки, то перед их запуском необходимо зайти по пути `/etc/`, выполнить команду `sudo nano environment` и закомментировать строчку `PATH=$PATH:$JAVA_HOME/bin`, чтобы она приобрела вид `#PATH=$PATH:$JAVA_HOME/bin`. В противном случае последующие плейбуки не будут запускаться, и может нарушиться работа прав пользователя для Ansible. После того, как необходимость в запуске новых плейбуков отпадет, нужно вновь раскомментировать строчку `PATH=$PATH:$JAVA_HOME/bin`.

12. **`versioning_linux_configs`**: Добавление задачи в CRON для синхронизации конфигурационных файлов сервера с содержимым GitLab.

## Особенности работы

- Скопируйте каталог `ansible` на свой компьютер, например, в корень.
- Переопределите переменные, описанные выше.
- Пользователь на хостах должен быть таким же, как и пользователь на компьютере, с которого устанавливается. Пароль тоже должен быть одинаковым.
- Если нет необходимости выполнять определенную роль, ее можно закомментировать в файле `side.yml`.
- Например, при установке новой версии платформы 1С на хосты, на которые уже есть старая версия 1С, можно отключить роль `first_setup`. Для этого можно либо удалить, либо закомментировать строку.
- Если требуется на один хост установить несколько служб приложений сервера 1С, заполните переменные для второй службы и закомментируйте все роли, кроме `install_ragent`.
- Такой же подход можно использовать для публикации дополнительных баз 1С на веб-сервере.
- Настройте список хостов в файле `hosts`.
- Запуск основного плейбука выполняется из каталога `Ansible` командой:
  ```bash
  ansible-playbook -i hosts side.yml -K
  ```
  Параметр `-K` указывает на выполнение некоторых задач под `sudo` и требует ввода пароля.
